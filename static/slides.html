<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒ©ã‚¤ãƒ‰ç¢ºèª - ã‚¹ãƒ©ã‚¤ãƒ‰ä½œæˆã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="slides-container">
        <!-- å·¦å´: ãƒãƒ£ãƒƒãƒˆ -->
        <div class="chat-panel">
            <div class="chat-header">
                <h2>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆç·¨é›†</h2>
                <a href="/" class="btn btn-secondary btn-sm">â† å…¥åŠ›ç”»é¢ã«æˆ»ã‚‹</a>
            </div>

            <div id="chat-messages" class="chat-messages">
                <div class="chat-message bot">
                    <p>ã‚¹ãƒ©ã‚¤ãƒ‰æ§‹æˆæ¡ˆã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼</p>
                    <p>ãƒãƒ£ãƒƒãƒˆã§ç·¨é›†ã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¯èƒ½ã§ã™ï¼š</p>
                    <ul>
                        <li>ã€Œæœ€å¾Œã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å‰Šé™¤ã€</li>
                        <li>ã€Œæ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¿½åŠ ã€</li>
                        <li>ã€Œã‚¿ã‚¤ãƒˆãƒ«ã‚’ã€‡ã€‡ã«å¤‰æ›´ã€</li>
                    </ul>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="preset-buttons">
                    <button onclick="sendPreset('æœ€å¾Œã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å‰Šé™¤')" class="btn-preset">
                        æœ€å¾Œã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å‰Šé™¤
                    </button>
                    <button onclick="sendPreset('æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¿½åŠ ')" class="btn-preset">
                        æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¿½åŠ 
                    </button>
                    <button onclick="sendPreset('ã‚‚ã£ã¨å…·ä½“çš„ã«')" class="btn-preset">
                        ã‚‚ã£ã¨å…·ä½“çš„ã«
                    </button>
                </div>

                <div class="chat-input-box">
                    <input type="text"
                           id="chat-input"
                           placeholder="ç·¨é›†å†…å®¹ã‚’å…¥åŠ›..."
                           onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()" class="btn btn-primary">é€ä¿¡</button>
                </div>
            </div>
        </div>

        <!-- å³å´: ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div class="preview-panel">
            <div class="preview-header">
                <h2>ğŸ“Š ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                <button onclick="exportPPTX()" class="btn btn-success">
                    ğŸ“¥ PPTXã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>

            <div id="slides-preview" class="slides-preview">
                <!-- ã‚¹ãƒ©ã‚¤ãƒ‰ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script>
        let slides = [];

        // åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            loadSlides();
            renderSlides();
        });

        function loadSlides() {
            const data = localStorage.getItem('slidesData');
            if (data) {
                slides = JSON.parse(data);
            } else {
                // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                window.location.href = '/';
            }
        }

        function renderSlides() {
            const container = document.getElementById('slides-preview');
            container.innerHTML = '';

            slides.forEach((slide, index) => {
                const slideCard = document.createElement('div');
                slideCard.className = 'slide-card';
                slideCard.id = `slide-${index}`;

                slideCard.innerHTML = `
                    <div class="slide-number">Slide ${index + 1}</div>
                    <input type="text"
                           class="slide-title-input"
                           value="${escapeHtml(slide.title)}"
                           onchange="updateSlideTitle(${index}, this.value)">

                    <div class="message-line-section">
                        <label class="message-line-label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ©ã‚¤ãƒ³:</label>
                        <input type="text"
                               class="message-line-input"
                               value="${escapeHtml(slide.bullets[0] || '')}"
                               onchange="updateBullet(${index}, 0, this.value)"
                               placeholder="æ ¸å¿ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
                    </div>

                    <div class="body-preview-note">
                        â€» ãƒœãƒ‡ã‚£éƒ¨åˆ†ï¼ˆ${slide.bullets.length - 1}é …ç›®ï¼‰ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã€PPTXå‡ºåŠ›æ™‚ã«å«ã¾ã‚Œã¾ã™
                    </div>

                    <div class="slide-actions">
                        <button onclick="duplicateSlide(${index})" class="btn-action">ğŸ“‹ è¤‡è£½</button>
                        <button onclick="moveSlide(${index}, -1)" class="btn-action" ${index === 0 ? 'disabled' : ''}>â¬†ï¸</button>
                        <button onclick="moveSlide(${index}, 1)" class="btn-action" ${index === slides.length - 1 ? 'disabled' : ''}>â¬‡ï¸</button>
                        <button onclick="deleteSlide(${index})" class="btn-action btn-danger">ğŸ—‘ï¸</button>
                    </div>
                `;

                container.appendChild(slideCard);
            });

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            localStorage.setItem('slidesData', JSON.stringify(slides));
        }

        function updateSlideTitle(index, newTitle) {
            slides[index].title = newTitle;
            localStorage.setItem('slidesData', JSON.stringify(slides));
        }

        function updateBullet(slideIndex, bulletIndex, newValue) {
            slides[slideIndex].bullets[bulletIndex] = newValue;
            localStorage.setItem('slidesData', JSON.stringify(slides));
        }

        function addBullet(slideIndex) {
            slides[slideIndex].bullets.push('æ–°ã—ã„é …ç›®');
            renderSlides();
        }

        function removeBullet(slideIndex, bulletIndex) {
            slides[slideIndex].bullets.splice(bulletIndex, 1);
            renderSlides();
        }

        function duplicateSlide(index) {
            const newSlide = JSON.parse(JSON.stringify(slides[index]));
            slides.splice(index + 1, 0, newSlide);
            renderSlides();
        }

        function moveSlide(index, direction) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < slides.length) {
                [slides[index], slides[newIndex]] = [slides[newIndex], slides[index]];
                renderSlides();
            }
        }

        function deleteSlide(index) {
            if (confirm('ã“ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                slides.splice(index, 1);
                renderSlides();
            }
        }

        function sendPreset(message) {
            document.getElementById('chat-input').value = message;
            sendMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const prompt = input.value.trim();

            if (!prompt) return;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addChatMessage(prompt, 'user');
            input.value = '';

            try {
                const response = await fetch('/patch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ slides, prompt })
                });

                if (!response.ok) {
                    throw new Error('ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const data = await response.json();
                slides = data.slides;
                renderSlides();

                // ãƒœãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                addChatMessage('ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼', 'bot');

            } catch (error) {
                console.error('Error:', error);
                addChatMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'bot');
            }
        }

        function addChatMessage(text, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = `<p>${escapeHtml(text)}</p>`;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function exportPPTX() {
            try {
                const response = await fetch('/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ slides })
                });

                if (!response.ok) {
                    throw new Error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const data = await response.json();

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const link = document.createElement('a');
                link.href = data.download_url;
                link.download = data.filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                addChatMessage('PPTXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼', 'bot');

            } catch (error) {
                console.error('Error:', error);
                alert('PPTXã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
